<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin · ShelfCam</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f8fafc;margin:0}
    .wrap{max-width:1120px;margin:0 auto;padding:16px 16px 28px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);margin-top:16px}
    .btn{display:inline-block;background:#111827;color:#fff;border-radius:10px;padding:8px 14px;text-decoration:none;border:0;cursor:pointer}
    .btn.secondary{background:#fff;color:#111827;border:1px solid #e5e7eb}
    .grid{display:grid;gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .field label{display:block;font-size:12px;color:#6b7280;margin-bottom:4px}
    .field input,.field select{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
    .table{width:100%;border-collapse:separate;border-spacing:0 6px}
    .table th{font-size:12px;color:#6b7280;text-align:left;padding:6px 8px}
    .table td{background:#fff;border:1px solid #e5e7eb;border-left:none;border-right:none;padding:10px 8px}
    .slot{position:absolute;border:2px solid #10b981;border-radius:8px;font-size:10px;
          display:flex;align-items:center;justify-content:center;background:rgba(16,185,129,.12)}
    .slot.empty{border-color:#ef4444;background:rgba(239,68,68,.12)}
  </style>
</head>
<body>
<div class="wrap">
  <h1 style="font-size:20px;margin:4px 0 14px">ShelfCam • Admin</h1>

  <section class="card">
    <h2 style="font-size:16px;margin:0 0 10px">Add a new SKU</h2>
    <form id="skuForm" class="grid">
      <div class="field">
        <label>Name</label>
        <input name="name" placeholder="Mentos Mint (Single)" required>
      </div>

      <div class="grid grid2">
        <div class="field">
          <label>Barcode (optional)</label>
          <input name="barcode" placeholder="EAN/UPC">
        </div>
        <div class="field">
          <label>Image URL (optional)</label>
          <input name="image_url" placeholder="https://...">
        </div>
      </div>

      <div class="grid grid2">
        <div class="field">
          <label>Detector</label>
          <select name="detector">
            <option value="">(auto/mentos default)</option>
            <option value="mentos">Mentos (circles/rows)</option>
            <option value="red_blobs">Red packs (HSV)</option>
            <option value="blue_blobs">Blue packs (HSV)</option>
            <option value="presence_box">Presence only</option>
          </select>
        </div>
        <div class="field">
          <label>Detector params (JSON)</label>
          <input name="det_params" placeholder='{"min_radius":12,"max_radius":36,"merge_y":28}'>
        </div>
      </div>

      <div>
        <label style="font-size:12px;color:#6b7280;display:inline-flex;align-items:center;gap:8px">
          <input id="autoPlace" name="auto_place" type="checkbox" checked>
          Auto-place into first empty slot
        </label>
      </div>

      <div id="slotPicker" class="field" style="display:none">
        <label>Choose empty slot</label>
        <select name="desired_slot_id" id="slotSelect"></select>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn" type="submit">Add SKU</button>
        <span id="skuMsg" style="font-size:12px;color:#6b7280"></span>
      </div>
    </form>
  </section>

  <section class="card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2 style="font-size:16px;margin:0">Slots & Assignments</h2>
      <button id="refreshBtn" class="btn secondary" type="button">Refresh</button>
    </div>
    <div id="canvasWrap" style="margin-top:10px;position:relative;width:100%;">
      <div id="slotCanvas" style="position:absolute;inset:0;background:#f3f4f6;border-radius:12px;overflow:hidden"></div>
    </div>
    <p style="font-size:12px;color:#6b7280;margin:8px 0 0">Canvas: {{W}}×{{H}}</p>
  </section>

  <section class="card">
    <h2 style="font-size:16px;margin:0 0 10px">All SKUs</h2>
    <div style="overflow-x:auto">
      <table class="table">
        <thead><tr><th>ID</th><th>Name</th><th>Barcode</th><th>Detector</th><th>Slot</th></tr></thead>
        <tbody id="skuTable"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
if (typeof window.W === 'undefined') {
  window.W = {{W}};
  window.H = {{H}};
}
const $ = q => document.querySelector(q);
document.addEventListener('DOMContentLoaded', () => {
  const cw = document.getElementById('canvasWrap');
  if (cw && typeof window.W !== 'undefined' && typeof window.H !== 'undefined') {
    cw.style.aspectRatio = window.W + '/' + window.H;
  }
});
async function j(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }

function renderSlots(slots){
  const wrap = $("#slotCanvas"); wrap.innerHTML = "";
  const rect = wrap.getBoundingClientRect();
  const sx = rect.width / W, sy = rect.height / H;
  const sel = $("#slotSelect"); sel.innerHTML = "";
  slots.forEach(s=>{
    const d = document.createElement("div");
    d.className = "slot" + (s.occupied_by_sku ? "" : " empty");
    d.style.left = (s.x*sx) + "px";
    d.style.top  = (s.y*sy) + "px";
    d.style.width  = (s.w*sx) + "px";
    d.style.height = (s.h*sy) + "px";
    d.title = (s.label || ("Slot " + s.id)) + " (ID " + s.id + ")";
    d.textContent = s.sku_name || s.label || ("Slot " + s.id);
    wrap.appendChild(d);
    if(!s.occupied_by_sku){
      const opt = document.createElement("option");
      opt.value = s.id; opt.textContent = (s.label || ("Slot " + s.id)) + " (ID " + s.id + ")";
      sel.appendChild(opt);
    }
  });
}

async function reload(){
  const slots = (await j("/api/slots")).slots; renderSlots(slots);
  const rows = (await j("/api/skus")).skus;
  const tb = $("#skuTable"); tb.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td><td>${r.name}</td>
      <td>${r.barcode || "—"}</td>
      <td>${r.detector || "—"}</td>
      <td>${r.slot_id ? (r.label || ("Slot "+r.slot_id)) : "—"}</td>`;
    tb.appendChild(tr);
  });
}

$("#autoPlace").addEventListener("change", e=>{
  document.getElementById("slotPicker").style.display = e.target.checked ? "none" : "block";
});

document.getElementById("skuForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.set("auto_place", document.getElementById("autoPlace").checked ? "true" : "false");
  const r = await fetch("/api/skus", { method: "POST", body: fd });
  const jdata = await r.json();
  document.getElementById("skuMsg").textContent = r.ok ? ("Added (slot #" + jdata.slot_id + ")") : ("Error: " + (jdata.detail || "failed"));
  if (r.ok) { e.target.reset(); document.getElementById("autoPlace").checked = true; document.getElementById("slotPicker").style.display = "none"; }
  reload();
});

document.getElementById("refreshBtn").addEventListener("click", reload);
reload();
</script>
</body>
</html>
